## Barcode TAB-Code Listener

Испольуемый сканер: Poscenter HH 2D HH.

Включаем на сканере режим эмуляции клавиатуры, режим «ALT+Number output», включаем передачу CR+LF.
Это нужно для того, чтобы в режиме эмуляции USB-HID клавиатуры  отсутствовало влияние текущей раскладки и передавались непечатные символы, в частности, разделитель GS (код 29).
В конец каждого считанного штрихкода сканер добавит символы CR и LF. Это даст дополнительную уверенность того, что мы обрабатываем последовательность символов со сканера, а не клавиатуры.

Для отличия текста, набираемого человеком от последовательностей, передаваемых сканером в ежиме эмуляции клавиатуры, замеряется время между получением символов. Если временная задержка между символами больше заданной, то полученная последовательность «забывается» и начинается новый захват. 

Временной порог (maxKeyboardDelay) настраивается в конструкторе BarcodeListener. Значение порога по-умолчанию равно 200 миллисекундам.

``` js
// Переданные в конструктор значения параметров соответствуют дефолтным значениям
var bs = new BarcodeListener({
    // режим отладки
    debug: false,
    // временная задержка между символами
    maxKeyboardDelay: 200,
    // минимальная длина ожидаемой последовательности
    minLength: 5,
    // игнорировать ввод при активном курсоре внутри текстового поля. 
    ignoreInputs: false,
    // захват ввода сразу после создания экземпляра BarcodeListener
    autoStart: false
});

// включить захват ввода
bs.enable();

// выключить захват ввода
bs.disable();
```

После получения последовательности, BarcodeListener на document генерирует событие barcode

```js
// barcode event
{
    detail: {
        // полученная последовательность 
        sequence: string,
        // признак ввода на текстовом поле
        onTextField: boolean
    }
}
```


Мы не можем из браузера остановить случайный ввод на текстовом поле, но по признаку «onTextField» мы можем определить это.
Можно в карточке товара разместить кнопку «Считать маркировку сканером». Нажатие этой кнопки сместит фокус с текстовых полей и не даст эмулированной сканером клавиатуре испортить набранное.

Пример:

```js
var bs = new BarcodeListener({
    debug: true,
});

$('button').on('click', function() {
    bs.enable();
});

// JQuery
$(document).on('barcode', function(e, str) {
    bs.disable()
    alert(e.detail.sequence);
});

// Vanilla JS
document.addEventListener('barcode', function(e) {
    bs.disable()
    alert(e.detail.sequence);
})

```

Бывает так, что рядом с маркировкой находятся другие штрихкоды. Мы можем предотвратить получение неправильного кода оператором (всякое бывает). Для этого можно полученную последовательность проверить парсером (см. секцию Barcode Parser), и если не сошлось, то уведомить оператора.
Пример решения. 
По нажатию кнопки «Считать маркировку сканером» включить захват, вывести модальное окно с краткой (!) инструкцией. Что-то типа образца DataMatrix штрихкода и надписи «Найдите на упаковке похожий штрихкод, наведите сканер и нажмите кнопку».
После считывания проверить парсером код и, в случае успеха, скрыть блок инструкции и уведомить об успехе короткой фразой. Например, «код принят» или что-то в этом роде. По нажатию кнопки закрытия диалогового окна сохранить код маркировки в карточке.
Если код не прошёл проверку парсером, то вывести что-то типа «Странный код маркировки. Нажмите OK, если вы уверены в правильности типа сканируемого штрихкода.»
Полученный код сохранить, но пометить в БД для последующей ручной проверки.



## Barcode Parser

``` js
// AI - GS1 Application Identifier 
// Ожидаемые AI в русской маркировке и их коды
var AIS = {
    GTIN: '01',
    SERIAL: '21',
    TNVED: '240',
    VALIDATION: '91',
    CRYPTO: '92',
    SSCC: '00',
};

//  Сообщаем какие идентификаторы будут парситься —
//  — по дефолту парсер ничего не о них знает
//      Пример:
//      GS1_BarcodeParser.setKnownAIs(['01', '21']);
GS1_BarcodeParser.setKnownAIs([
    AIS.GTIN,
    AIS.SERIAL,
    AIS.TNVED,
    AIS.VALIDATION,
    AIS.CRYPTO,
    AIS.SSCC,
]);

// Тестовый штрих-код
var code = ']d2010460702776747121000001KOL6P5Y910000920000000000000000000000000000000000000000000';

var barcode;
try {
    // смотри описание структуры barcode в ./typings/parser.d.ts
    barcode = GS1_BarcodeParser.parse(code)
    barcode.fnc1Prefix = ']d2';
    // Проверка по GTIN и SERIAL
    if (barcode && barcode.hasAI(AIS.GTIN) && barcode.hasAI(AIS.SERIAL)) {
        // Тут мы можем быть точно уверены, что штрих-код корректный 
        console.log('BARCODE IS VALID')
    }
} catch (e) {
    // Если мы здесь, то штрих-код некорректный
    console.log(e);
}
```
